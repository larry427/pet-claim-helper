-- ============================================================================
-- SECURITY FIX: Remove overly permissive RLS policies
-- ============================================================================
--
-- PROBLEM: The fix-magic-link-rls-v2.sql migration created policies with
-- USING (true) that allow ANY unauthenticated user to read ALL data from:
--   - medication_doses (all dose records for all users)
--   - medications (all medication names, dosages, schedules)
--   - pets (all pet names, breeds, policy numbers, insurance details)
--
-- This is a critical security vulnerability exposing user PII and medical data.
--
-- SOLUTION:
--   1. Drop the dangerous "Public can read" policies
--   2. Restore proper authenticated-only policies
--   3. For medication_doses: Allow limited public access ONLY for magic link
--      doses (where short_code IS NOT NULL) - required for SMS dose confirmation
--
-- NOTE: The server uses SUPABASE_SERVICE_ROLE_KEY which bypasses RLS entirely.
-- The magic link API endpoint (/api/medications/:id/mark-given) uses service
-- role, so it doesn't need public RLS policies to function.
--
-- Migration Date: 2026-01-26
-- ============================================================================

-- ============================================================================
-- STEP 1: DROP DANGEROUS POLICIES
-- ============================================================================

-- Drop the blanket "read everything" policies
DROP POLICY IF EXISTS "Public can read doses by token" ON medication_doses;
DROP POLICY IF EXISTS "Public can read medications" ON medications;
DROP POLICY IF EXISTS "Public can read pets" ON pets;

-- Also drop any legacy policies that might conflict
DROP POLICY IF EXISTS "Allow select with valid token" ON medication_doses;
DROP POLICY IF EXISTS "Allow public read for magic links" ON medications;
DROP POLICY IF EXISTS "Allow public read for magic links" ON pets;

-- ============================================================================
-- STEP 2: MEDICATION_DOSES - Secure policies
-- ============================================================================

-- Ensure RLS is enabled
ALTER TABLE medication_doses ENABLE ROW LEVEL SECURITY;

-- Drop existing authenticated policies to recreate cleanly
DROP POLICY IF EXISTS "Users can view own doses" ON medication_doses;
DROP POLICY IF EXISTS "Users can insert own doses" ON medication_doses;
DROP POLICY IF EXISTS "Users can update own doses" ON medication_doses;
DROP POLICY IF EXISTS "Users can delete own doses" ON medication_doses;
DROP POLICY IF EXISTS "med_doses_select_own" ON medication_doses;
DROP POLICY IF EXISTS "med_doses_insert_own" ON medication_doses;
DROP POLICY IF EXISTS "med_doses_update_own" ON medication_doses;
DROP POLICY IF EXISTS "med_doses_delete_own" ON medication_doses;
DROP POLICY IF EXISTS "Users manage own doses" ON medication_doses;

-- Authenticated users: Full access to their own doses
CREATE POLICY "Authenticated users can view own doses"
ON medication_doses FOR SELECT TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Authenticated users can insert own doses"
ON medication_doses FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Authenticated users can update own doses"
ON medication_doses FOR UPDATE TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Authenticated users can delete own doses"
ON medication_doses FOR DELETE TO authenticated
USING (auth.uid() = user_id);

-- Public/Anon: LIMITED read access for magic link doses ONLY
-- This allows the frontend to display dose info when user clicks SMS link
-- The short_code acts as a bearer token - only those with the code can read
-- NOTE: short_code is an 8-char random alphanumeric, so brute force is impractical
CREATE POLICY "Public can read doses with valid short_code"
ON medication_doses FOR SELECT TO anon
USING (short_code IS NOT NULL);

-- ============================================================================
-- STEP 3: MEDICATIONS - Authenticated only (no public access)
-- ============================================================================

-- Ensure RLS is enabled
ALTER TABLE medications ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to recreate cleanly
DROP POLICY IF EXISTS "Users can view own medications" ON medications;
DROP POLICY IF EXISTS "Users manage own medications" ON medications;
DROP POLICY IF EXISTS "medications_select_own" ON medications;
DROP POLICY IF EXISTS "medications_insert_own" ON medications;
DROP POLICY IF EXISTS "medications_update_own" ON medications;
DROP POLICY IF EXISTS "medications_delete_own" ON medications;

-- Authenticated users: Full access to their own medications
CREATE POLICY "Authenticated users can view own medications"
ON medications FOR SELECT TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Authenticated users can insert own medications"
ON medications FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Authenticated users can update own medications"
ON medications FOR UPDATE TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Authenticated users can delete own medications"
ON medications FOR DELETE TO authenticated
USING (auth.uid() = user_id);

-- NO PUBLIC ACCESS to medications table
-- Server uses service role key for magic link queries

-- ============================================================================
-- STEP 4: PETS - Authenticated only (no public access)
-- ============================================================================

-- Ensure RLS is enabled
ALTER TABLE pets ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to recreate cleanly
DROP POLICY IF EXISTS "Users can view own pets" ON pets;
DROP POLICY IF EXISTS "Users manage own pets" ON pets;
DROP POLICY IF EXISTS "pets_select_own" ON pets;
DROP POLICY IF EXISTS "pets_insert_own" ON pets;
DROP POLICY IF EXISTS "pets_update_own" ON pets;
DROP POLICY IF EXISTS "pets_delete_own" ON pets;

-- Authenticated users: Full access to their own pets
CREATE POLICY "Authenticated users can view own pets"
ON pets FOR SELECT TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Authenticated users can insert own pets"
ON pets FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Authenticated users can update own pets"
ON pets FOR UPDATE TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Authenticated users can delete own pets"
ON pets FOR DELETE TO authenticated
USING (auth.uid() = user_id);

-- NO PUBLIC ACCESS to pets table
-- Server uses service role key for magic link queries

-- ============================================================================
-- VERIFICATION QUERIES (run these after migration to confirm)
-- ============================================================================

-- Check all policies are correctly configured:
--
-- SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
-- FROM pg_policies
-- WHERE tablename IN ('medication_doses', 'medications', 'pets')
-- ORDER BY tablename, policyname;
--
-- Expected results:
-- medication_doses | Authenticated users can delete own doses | {authenticated} | DELETE
-- medication_doses | Authenticated users can insert own doses | {authenticated} | INSERT
-- medication_doses | Authenticated users can update own doses | {authenticated} | UPDATE
-- medication_doses | Authenticated users can view own doses   | {authenticated} | SELECT
-- medication_doses | Public can read doses with valid short_code | {anon}       | SELECT
-- medications      | Authenticated users can delete own medications | {authenticated} | DELETE
-- medications      | Authenticated users can insert own medications | {authenticated} | INSERT
-- medications      | Authenticated users can update own medications | {authenticated} | UPDATE
-- medications      | Authenticated users can view own medications   | {authenticated} | SELECT
-- pets             | Authenticated users can delete own pets | {authenticated} | DELETE
-- pets             | Authenticated users can insert own pets | {authenticated} | INSERT
-- pets             | Authenticated users can update own pets | {authenticated} | UPDATE
-- pets             | Authenticated users can view own pets   | {authenticated} | SELECT

-- ============================================================================
-- SECURITY NOTES
-- ============================================================================
--
-- 1. MAGIC LINK FLOW (how it still works):
--    - User clicks SMS link -> /dose/:shortCode
--    - Frontend calls server API: POST /api/medications/:id/mark-given
--    - Server uses SERVICE_ROLE_KEY (bypasses RLS) to query/update dose
--    - No public RLS policy needed for the core functionality
--
-- 2. DOSE DISPLAY (why we need limited public access):
--    - The frontend DoseMarkingPage may need to display medication info
--    - It can read the dose record via short_code (limited exposure)
--    - Full medication/pet details come from server API (service role)
--
-- 3. SECURITY IMPROVEMENT:
--    - BEFORE: Anyone could read ALL medications, pets, and doses
--    - AFTER:
--      * medications/pets: Only authenticated owner can read
--      * doses: Authenticated owner OR anyone with the short_code
--
-- 4. REMAINING RISK (acceptable):
--    - Doses with short_code can be read by anyone who has the code
--    - Mitigated by: 8-char random code (62^8 = 218 trillion combinations)
--    - Mitigated by: short_code only exists for doses with active reminders
--
-- ============================================================================
